<html lang="en">
<head>
  <title>Red Global</title>
  <script type="text/javascript" charset="utf-8">
    
  // Set up the Listener  
      safari.application.addEventListener("command", performCommand, false);
      safari.application.addEventListener("message", respondToMessage, false);
 
      var socket;
      var t;

      OpenWebSocket();

      function OpenWebSocket() {

          if (socket == undefined || socket.readyState != 1) { // readState is not open
              socket = new WebSocket("ws://localhost:49803/service");
              t = setTimeout("OpenWebSocket()", 1000);
          } else {
              clearTimeout(t);
          }

      }
      
      function performCommand(event) {  
      // Make sure event comes from the button 
      command = event.command;
          if (command == 'addReadingListItem') {
              socket.send(event.userInfo);
          }

  }
      
      
        
  
  //respond to middle clicks
  function respondToMessage(messageEvent) {
    if (messageEvent.name === 'addReadingListItem') {
        socket.send(messageEvent.message);
    }
  
  }
    
  </script>
</head>
</html>